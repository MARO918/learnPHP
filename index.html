<!doctype html>
<html lang="ja" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å˜èªãƒãƒƒãƒãƒ³ã‚°ã‚²ãƒ¼ãƒ </title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="/_sdk/data_sdk.js"></script>
  <script src="/_sdk/element_sdk.js"></script>
  <style>
    /* å…¨è¦ç´ ã«å¯¾ã—ã¦ box-sizing ã‚’é©ç”¨ */
    *, *::before, *::after {
      box-sizing: border-box;
    }

    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700;900&display=swap');

    body {
      margin: 0;
      font-family: 'Noto Sans JP', sans-serif;
    }

    @keyframes celebrate {
      0%, 100% { transform: scale(1) rotate(0deg); }
      25% { transform: scale(1.2) rotate(-5deg); }
      75% { transform: scale(1.2) rotate(5deg); }
    }

    @keyframes confetti {
      0% { transform: translateY(0) rotate(0deg); opacity: 1; }
      100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
    }

    .celebrate {
      animation: celebrate 0.6s ease-in-out;
    }

    .confetti {
      position: fixed;
      width: 10px;
      height: 10px;
      pointer-events: none;
      animation: confetti 3s ease-out forwards;
      z-index: 9999;
    }

    .term-card, .description-card {
      transition: all 0.3s ease;
      cursor: pointer;
    }

    .term-card:hover, .description-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 16px rgba(0,0,0,0.2);
    }

    .selected {
      transform: scale(1.05);
      box-shadow: 0 0 0 3px rgba(255,255,255,0.5);
    }

    .matched {
      opacity: 0.5;
      pointer-events: none;
    }

    @media (max-width: 768px) {
      .text-5xl { font-size: 2rem; }
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
 </head>
 <body class="h-full">
  <div id="app" class="w-full h-full overflow-auto"></div>
  <script>
    const phpMethods = [
      { term: "array_map()", description: "é…åˆ—ã®å„è¦ç´ ã«ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯é–¢æ•°ã‚’é©ç”¨ã—ã¦æ–°ã—ã„é…åˆ—ã‚’è¿”ã™" },
      { term: "array_filter()", description: "ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯é–¢æ•°ã‚’ä½¿ç”¨ã—ã¦é…åˆ—ã®è¦ç´ ã‚’ãƒ•ã‚£ãƒ«ã‚¿ã™ã‚‹ï¼ˆæ¡ä»¶ã‚’æº€ãŸã™è¦ç´ ã®ã¿è¿”ã™ï¼‰" },
      { term: "array_reduce()", description: "é…åˆ—ã®è¦ç´ ã‚’ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã§é›†ç´„ã—ã¦å˜ä¸€ã®å€¤ã«é‚„å…ƒã™ã‚‹" },
      { term: "array_merge()", description: "ä¸€ã¤ã¾ãŸã¯ãã‚Œä»¥ä¸Šã®é…åˆ—ã‚’çµåˆã—ã¦æ–°ã—ã„é…åˆ—ã‚’è¿”ã™" },
      { term: "array_slice()", description: "é…åˆ—ã®ä¸€éƒ¨ã‚’å–å¾—ã—ã¦æ–°ã—ã„é…åˆ—ã‚’è¿”ã™" },
      { term: "array_push()", description: "ä¸€ã¤ä»¥ä¸Šã®è¦ç´ ã‚’é…åˆ—ã®æœ«å°¾ã«è¿½åŠ ã™ã‚‹ï¼ˆé…åˆ—ã‚’ç›´æ¥å¤‰æ›´ã™ã‚‹ï¼‰" },
      { term: "array_pop()", description: "é…åˆ—ã®æœ«å°¾ã‹ã‚‰è¦ç´ ã‚’å–ã‚Šé™¤ãã€ãã®å€¤ã‚’è¿”ã™" },
      { term: "array_shift()", description: "é…åˆ—ã®å…ˆé ­ã‹ã‚‰è¦ç´ ã‚’å–ã‚Šå‡ºã—ã€ãã®å€¤ã‚’è¿”ã™ï¼ˆé…åˆ—ã‚’çŸ­ãã™ã‚‹ï¼‰" },
      { term: "array_unshift()", description: "ä¸€ã¤ä»¥ä¸Šã®è¦ç´ ã‚’é…åˆ—ã®å…ˆé ­ã«è¿½åŠ ã™ã‚‹" },
      { term: "array_keys()", description: "é…åˆ—ã®ã™ã¹ã¦ã®ã‚­ãƒ¼ã‚’é…åˆ—ã¨ã—ã¦è¿”ã™" },
      { term: "array_values()", description: "é…åˆ—ã®ã™ã¹ã¦ã®å€¤ã‚’é…åˆ—ã¨ã—ã¦è¿”ã™" },
      { term: "array_search()", description: "æŒ‡å®šã—ãŸå€¤ã‚’é…åˆ—ã§æ¤œç´¢ã—ã€è¦‹ã¤ã‹ã£ãŸå ´åˆã«å¯¾å¿œã™ã‚‹ã‚­ãƒ¼ã‚’è¿”ã™ï¼ˆè¦‹ã¤ã‹ã‚‰ãªã‘ã‚Œã° falseï¼‰" },
      { term: "in_array()", description: "é…åˆ—ã«æŒ‡å®šã—ãŸå€¤ãŒå­˜åœ¨ã™ã‚‹ã‹ã‚’çœŸå½å€¤ã§è¿”ã™" },
      { term: "count()", description: "é…åˆ—ã®è¦ç´ æ•°ã€ã¾ãŸã¯ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£æ•°ã‚’è¿”ã™" },
      { term: "sort()", description: "é…åˆ—ã‚’å€¤ã§æ˜‡é †ã«ã‚½ãƒ¼ãƒˆã™ã‚‹ï¼ˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã¯å†å‰²ã‚Šå½“ã¦ã•ã‚Œã‚‹ï¼‰" },
      { term: "rsort()", description: "é…åˆ—ã‚’å€¤ã§é™é †ã«ã‚½ãƒ¼ãƒˆã™ã‚‹ï¼ˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã¯å†å‰²ã‚Šå½“ã¦ã•ã‚Œã‚‹ï¼‰" },
      { term: "asort()", description: "é€£æƒ³é…åˆ—ã‚’å€¤ã§æ˜‡é †ã«ã‚½ãƒ¼ãƒˆã™ã‚‹ï¼ˆã‚­ãƒ¼ã¨é–¢é€£ä»˜ã‘ã‚’ç¶­æŒï¼‰" },
      { term: "ksort()", description: "é€£æƒ³é…åˆ—ã‚’ã‚­ãƒ¼ã§æ˜‡é †ã«ã‚½ãƒ¼ãƒˆã™ã‚‹" },
      { term: "explode()", description: "æ–‡å­—åˆ—ã‚’åŒºåˆ‡ã‚Šæ–‡å­—ã§åˆ†å‰²ã—ã¦é…åˆ—ã‚’è¿”ã™" },
      { term: "implode()", description: "é…åˆ—ã®è¦ç´ ã‚’åŒºåˆ‡ã‚Šæ–‡å­—ã§çµåˆã—ã¦æ–‡å­—åˆ—ã‚’è¿”ã™" },
      { term: "str_replace()", description: "æ¤œç´¢æ–‡å­—åˆ—ã«ä¸€è‡´ã—ãŸã™ã¹ã¦ã®éƒ¨åˆ†ã‚’ç½®æ›ã—ã¦æ–°ã—ã„æ–‡å­—åˆ—ã‚’è¿”ã™" },
      { term: "substr()", description: "æ–‡å­—åˆ—ã®ä¸€éƒ¨ï¼ˆæŒ‡å®šã®ä½ç½®ã‹ã‚‰é•·ã•åˆ†ï¼‰ã‚’è¿”ã™" },
      { term: "strlen()", description: "æ–‡å­—åˆ—ã®é•·ã•ï¼ˆãƒã‚¤ãƒˆæ•°ã¾ãŸã¯ãƒãƒ«ãƒãƒã‚¤ãƒˆå¯¾å¿œã«æ³¨æ„ï¼‰ã‚’è¿”ã™" },
      { term: "strpos()", description: "æ–‡å­—åˆ—å†…ã§éƒ¨åˆ†æ–‡å­—åˆ—ãŒæœ€åˆã«ç¾ã‚Œã‚‹ä½ç½®ã‚’è¿”ã™ï¼ˆè¦‹ã¤ã‹ã‚‰ãªã‘ã‚Œã° falseï¼‰" },
      { term: "trim()", description: "æ–‡å­—åˆ—ã®å…ˆé ­ã¨æœ«å°¾ã®ãƒ›ãƒ¯ã‚¤ãƒˆã‚¹ãƒšãƒ¼ã‚¹ã‚’å–ã‚Šé™¤ã" },
      { term: "strtolower()", description: "æ–‡å­—åˆ—ã‚’å°æ–‡å­—ã«å¤‰æ›ã™ã‚‹" },
      { term: "strtoupper()", description: "æ–‡å­—åˆ—ã‚’å¤§æ–‡å­—ã«å¤‰æ›ã™ã‚‹" },
      { term: "json_encode()", description: "å€¤ã‚’ JSON å½¢å¼ã®æ–‡å­—åˆ—ã«å¤‰æ›ã™ã‚‹" },
      { term: "json_decode()", description: "JSONæ–‡å­—åˆ—ã‚’ PHP ã®å€¤ï¼ˆé…åˆ—ã¾ãŸã¯ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆï¼‰ã«æˆ»ã™" },
      { term: "file_get_contents()", description: "ãƒ•ã‚¡ã‚¤ãƒ«ã®å†…å®¹ã‚’æ–‡å­—åˆ—ã¨ã—ã¦ä¸€æ‹¬ã§èª­ã¿è¾¼ã‚€" }
    ];

    const defaultConfig = {
      background_color: "#0f172a",
      card_background: "#1e293b",
      term_color: "#3b82f6",
      description_color: "#8b5cf6",
      text_color: "#f1f5f9",
      accent_color: "#10b981",
      font_family: "Noto Sans JP",
      font_size: 16,
      game_title: "å˜èªãƒãƒƒãƒãƒ³ã‚°ã‚²ãƒ¼ãƒ ",
      instruction_text: "ç”¨èªã¨èª¬æ˜ã‚’æ­£ã—ãçµã³ã¤ã‘ã¦ãã ã•ã„"
    };

    let selectedTerm = null;
    let selectedDescription = null;
    let matchedPairs = new Set();
    let correctCount = 0;
    let hintsUsed = 0;
    let gameStartTime = Date.now();
    let currentRecordCount = 0;

    const dataHandler = {
      onDataChanged(data) {
        currentRecordCount = data.length;
        renderLeaderboard(data);
      }
    };

    async function init() {
      // dataSdk ã¨ elementSdk ãŒå­˜åœ¨ã™ã‚‹ã‹ã‚¬ãƒ¼ãƒ‰
      try {
        if (window.dataSdk && typeof window.dataSdk.init === 'function') {
          const initResult = await window.dataSdk.init(dataHandler);
          if (!initResult?.isOk) {
            console.warn("dataSdk ãŒåˆæœŸåŒ–ã§ãã¾ã›ã‚“ã§ã—ãŸã€å†…éƒ¨ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã¯åˆ©ç”¨ã§ãã¾ã›ã‚“ã€‚");
          }
        } else {
          console.warn("dataSdk ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ï¼ˆé–‹ç™ºç”¨ï¼šã‚¹ã‚¿ãƒ– or ã‚µãƒ¼ãƒæœªæ¥ç¶šï¼‰ã€‚");
        }
      } catch (e) {
        console.warn("dataSdk init ã‚¨ãƒ©ãƒ¼:", e);
      }

      try {
        if (window.elementSdk && typeof window.elementSdk.init === 'function') {
          await window.elementSdk.init({
            defaultConfig,
            onConfigChange: async (config) => {
              applyConfigToExistingElements(config);
            },
            mapToCapabilities: (config) => ({
              recolorables: [
                {
                  get: () => config.background_color || defaultConfig.background_color,
                  set: (value) => {
                    config.background_color = value;
                    window.elementSdk.setConfig({ background_color: value });
                  }
                },
                {
                  get: () => config.card_background || defaultConfig.card_background,
                  set: (value) => {
                    config.card_background = value;
                    window.elementSdk.setConfig({ card_background: value });
                  }
                },
                {
                  get: () => config.text_color || defaultConfig.text_color,
                  set: (value) => {
                    config.text_color = value;
                    window.elementSdk.setConfig({ text_color: value });
                  }
                },
                {
                  get: () => config.term_color || defaultConfig.term_color,
                  set: (value) => {
                    config.term_color = value;
                    window.elementSdk.setConfig({ term_color: value });
                  }
                },
                {
                  get: () => config.accent_color || defaultConfig.accent_color,
                  set: (value) => {
                    config.accent_color = value;
                    window.elementSdk.setConfig({ accent_color: value });
                  }
                }
              ],
              borderables: [],
              fontEditable: {
                get: () => config.font_family || defaultConfig.font_family,
                set: (value) => {
                  config.font_family = value;
                  window.elementSdk.setConfig({ font_family: value });
                }
              },
              fontSizeable: {
                get: () => config.font_size || defaultConfig.font_size,
                set: (value) => {
                  config.font_size = value;
                  window.elementSdk.setConfig({ font_size: value });
                }
              }
            }),
            mapToEditPanelValues: (config) => new Map([
              ["game_title", config.game_title || defaultConfig.game_title],
              ["instruction_text", config.instruction_text || defaultConfig.instruction_text]
            ])
          });
        } else {
          console.warn("elementSdk ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ï¼ˆç·¨é›†ç”¨ã® SDK ãŒæœªæ¥ç¶šï¼‰ã€‚");
        }
      } catch (e) {
        console.warn("elementSdk init ã‚¨ãƒ©ãƒ¼:", e);
      }

      renderGame();
    }

    function applyConfigToExistingElements(config) {
      const customFont = config.font_family || defaultConfig.font_family;
      const baseSize = config.font_size || defaultConfig.font_size;
      const baseFontStack = 'sans-serif';

      document.body.style.background = config.background_color || defaultConfig.background_color;

      const title = document.getElementById('game-title');
      if (title) {
        title.textContent = config.game_title || defaultConfig.game_title;
        title.style.fontFamily = `${customFont}, ${baseFontStack}`;
        title.style.fontSize = `${baseSize * 2}px`;
        title.style.color = config.text_color || defaultConfig.text_color;
      }

      const instruction = document.getElementById('instruction-text');
      if (instruction) {
        instruction.textContent = config.instruction_text || defaultConfig.instruction_text;
        instruction.style.fontFamily = `${customFont}, ${baseFontStack}`;
        instruction.style.fontSize = `${baseSize}px`;
        instruction.style.color = config.text_color || defaultConfig.text_color;
      }

      const termCards = document.querySelectorAll('.term-card');
      termCards.forEach(card => {
        card.style.background = config.term_color || defaultConfig.term_color;
        card.style.fontFamily = `${customFont}, ${baseFontStack}`;
        card.style.fontSize = `${baseSize * 0.9}px`;
      });

      const descCards = document.querySelectorAll('.description-card');
      descCards.forEach(card => {
        card.style.background = config.description_color || defaultConfig.description_color;
        card.style.fontFamily = `${customFont}, ${baseFontStack}`;
        card.style.fontSize = `${baseSize * 0.85}px`;
      });

      const statsElements = document.querySelectorAll('.stat-text');
      statsElements.forEach(el => {
        el.style.fontFamily = `${customFont}, ${baseFontStack}`;
        el.style.fontSize = `${baseSize}px`;
        el.style.color = config.text_color || defaultConfig.text_color;
      });

      const buttons = document.querySelectorAll('.game-button');
      buttons.forEach(btn => {
        btn.style.background = config.accent_color || defaultConfig.accent_color;
        btn.style.fontFamily = `${customFont}, ${baseFontStack}`;
        btn.style.fontSize = `${baseSize * 0.9}px`;
      });

      const leaderboardItems = document.querySelectorAll('.leaderboard-item');
      leaderboardItems.forEach(item => {
        item.style.background = config.card_background || defaultConfig.card_background;
        item.style.fontFamily = `${customFont}, ${baseFontStack}`;
        item.style.fontSize = `${baseSize * 0.85}px`;
        item.style.color = config.text_color || defaultConfig.text_color;
      });
    }

    function shuffleArray(array) {
      const newArray = [...array];
      for (let i = newArray.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
      }
      return newArray;
    }

    function renderGame() {
      // å¿…ãšã‚²ãƒ¼ãƒ çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆï¼ˆå†æç”»æ™‚ã«å‰ã®ã‚¹ã‚³ã‚¢ã‚’ä¿æŒã—ãªã„ï¼‰
      selectedTerm = null;
      selectedDescription = null;
      matchedPairs.clear();
      correctCount = 0;
      hintsUsed = 0;
      gameStartTime = Date.now();

      const config = window.elementSdk?.config || defaultConfig;
      const customFont = config.font_family || defaultConfig.font_family;
      const baseSize = config.font_size || defaultConfig.font_size;
      const baseFontStack = 'sans-serif';

      const shuffledTerms = shuffleArray(phpMethods);
      const shuffledDescriptions = shuffleArray(phpMethods);

      const app = document.getElementById('app');
      app.innerHTML = `
        <div class="w-full min-h-full p-8" style="background: ${config.background_color || defaultConfig.background_color};">
          <div class="max-w-7xl mx-auto">
            <div class="text-center mb-8">
              <h1 id="game-title" class="text-5xl font-black mb-4" style="font-family: ${customFont}, ${baseFontStack}; font-size: ${baseSize * 2}px; color: ${config.text_color || defaultConfig.text_color};">
                ${config.game_title || defaultConfig.game_title}
              </h1>
              <p id="instruction-text" class="text-xl mb-6" style="font-family: ${customFont}, ${baseFontStack}; font-size: ${baseSize}px; color: ${config.text_color || defaultConfig.text_color};">
                ${config.instruction_text || defaultConfig.instruction_text}
              </p>

              <div class="flex justify-center gap-8 mb-6 flex-wrap">
                <div class="stat-text" style="font-family: ${customFont}, ${baseFontStack}; font-size: ${baseSize}px; color: ${config.text_color || defaultConfig.text_color};">
                  <span class="font-bold">æ­£è§£æ•°:</span> <span id="correct-count" class="text-2xl font-black">${correctCount}</span> / ${phpMethods.length}
                </div>
                <div class="stat-text" style="font-family: ${customFont}, ${baseFontStack}; font-size: ${baseSize}px; color: ${config.text_color || defaultConfig.text_color};">
                  <span class="font-bold">ãƒ’ãƒ³ãƒˆä½¿ç”¨:</span> <span id="hint-count" class="text-2xl font-black">${hintsUsed}</span>
                </div>
              </div>

              <button id="hint-btn" class="game-button px-6 py-3 rounded-lg text-white font-bold shadow-lg hover:shadow-xl transition-all" style="background: ${config.accent_color || defaultConfig.accent_color}; font-family: ${customFont}, ${baseFontStack}; font-size: ${baseSize * 0.9}px;">
                ğŸ’¡ ãƒ’ãƒ³ãƒˆã‚’è¦‹ã‚‹
              </button>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
              <div>
                <h2 class="text-2xl font-bold mb-4 text-center" style="font-family: ${customFont}, ${baseFontStack}; color: ${config.text_color || defaultConfig.text_color};">ç”¨èª</h2>
                <div id="terms-container" class="space-y-3">
                  ${shuffledTerms.map((item, index) => `
                    <div class="term-card p-4 rounded-lg text-white font-bold text-center shadow-lg" 
                         data-term="${item.term}" 
                         data-index="${index}"
                         style="background: ${config.term_color || defaultConfig.term_color}; font-family: ${customFont}, ${baseFontStack}; font-size: ${baseSize * 0.9}px;">
                      ${item.term}
                    </div>
                  `).join('')}
                </div>
              </div>

              <div>
                <h2 class="text-2xl font-bold mb-4 text-center" style="font-family: ${customFont}, ${baseFontStack}; color: ${config.text_color || defaultConfig.text_color};">èª¬æ˜</h2>
                <div id="descriptions-container" class="space-y-3">
                  ${shuffledDescriptions.map((item, index) => `
                    <div class="description-card p-4 rounded-lg text-white font-semibold shadow-lg" 
                         data-term="${item.term}" 
                         data-index="${index}"
                         style="background: ${config.description_color || defaultConfig.description_color}; font-family: ${customFont}, ${baseFontStack}; font-size: ${baseSize * 0.85}px;">
                      ${item.description}
                    </div>
                  `).join('')}
                </div>
              </div>
            </div>

            <div id="leaderboard-section" class="mt-12">
              <h2 class="text-3xl font-black mb-6 text-center" style="font-family: ${customFont}, ${baseFontStack}; color: ${config.text_color || defaultConfig.text_color};">ğŸ† ãƒªãƒ¼ãƒ€ãƒ¼ãƒœãƒ¼ãƒ‰</h2>
              <div id="leaderboard-container" class="max-w-2xl mx-auto space-y-3"></div>
            </div>
          </div>
        </div>
      `;

      attachEventListeners();
    }

    function attachEventListeners() {
      const termCards = document.querySelectorAll('.term-card');
      const descCards = document.querySelectorAll('.description-card');
      const hintBtn = document.getElementById('hint-btn');

      termCards.forEach(card => {
        card.addEventListener('click', () => selectTerm(card));
      });

      descCards.forEach(card => {
        card.addEventListener('click', () => selectDescription(card));
      });

      if (hintBtn) {
        hintBtn.addEventListener('click', showHint);
      }
    }

    function selectTerm(card) {
      const term = card.dataset.term;
      if (matchedPairs.has(term)) return;

      if (selectedTerm) {
        selectedTerm.classList.remove('selected');
      }

      selectedTerm = card;
      card.classList.add('selected');

      checkMatch();
    }

    function selectDescription(card) {
      const term = card.dataset.term;
      if (matchedPairs.has(term)) return;

      if (selectedDescription) {
        selectedDescription.classList.remove('selected');
      }

      selectedDescription = card;
      card.classList.add('selected');

      checkMatch();
    }

    function checkMatch() {
      if (!selectedTerm || !selectedDescription) return;

      const termValue = selectedTerm.dataset.term;
      const descValue = selectedDescription.dataset.term;

      if (termValue === descValue) {
        correctCount++;
        matchedPairs.add(termValue);

        selectedTerm.classList.add('matched', 'celebrate');
        selectedDescription.classList.add('matched', 'celebrate');

        createConfetti(selectedTerm);
        createConfetti(selectedDescription);

        const correctCountEl = document.getElementById('correct-count');
        if (correctCountEl) correctCountEl.textContent = correctCount;

        selectedTerm = null;
        selectedDescription = null;

        if (correctCount === phpMethods.length) {
          setTimeout(() => showCompletionModal(), 800);
        }
      } else {
        // ä¸æ­£è§£æ™‚ã¯ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ï¼ˆçŸ­æ™‚é–“ï¼‰
        selectedTerm.classList.add('shake-wrong');
        selectedDescription.classList.add('shake-wrong');
        setTimeout(() => {
          if (selectedTerm) selectedTerm.classList.remove('selected','shake-wrong');
          if (selectedDescription) selectedDescription.classList.remove('selected','shake-wrong');
          selectedTerm = null;
          selectedDescription = null;
        }, 500);
      }
    }

    function createConfetti(element) {
      const rect = element.getBoundingClientRect();
      const scrollX = window.scrollX || window.pageXOffset;
      const scrollY = window.scrollY || window.pageYOffset;
      const centerX = rect.left + rect.width / 2 + scrollX;
      const centerY = rect.top + rect.height / 2 + scrollY;
      const colors = ['#ff6b6b', '#4ecdc4', '#45b7d1', '#f9ca24', '#6c5ce7'];

      for (let i = 0; i < 15; i++) {
        const confetti = document.createElement('div');
        confetti.className = 'confetti';
        confetti.style.left = `${centerX + (Math.random() - 0.5) * 80}px`;
        confetti.style.top = `${centerY + (Math.random() - 0.5) * 40}px`;
        confetti.style.background = colors[Math.floor(Math.random() * colors.length)];
        confetti.style.animationDelay = `${Math.random() * 0.3}s`;
        confetti.style.animationDuration = `${2 + Math.random()}s`;
        confetti.style.transform = `rotate(${Math.random() * 360}deg)`;
        document.body.appendChild(confetti);

        setTimeout(() => confetti.remove(), 3500);
      }
    }

    function showHint() {
      const unmatchedTerms = phpMethods.filter(item => !matchedPairs.has(item.term));
      if (unmatchedTerms.length === 0) return;

      const randomItem = unmatchedTerms[Math.floor(Math.random() * unmatchedTerms.length)];

      const termCard = document.querySelector(`.term-card[data-term="${escapeSelector(randomItem.term)}"]`);
      const descCard = document.querySelector(`.description-card[data-term="${escapeSelector(randomItem.term)}"]`);

      if (termCard && descCard) {
        termCard.style.boxShadow = '0 0 20px 5px rgba(255, 215, 0, 0.8)';
        descCard.style.boxShadow = '0 0 20px 5px rgba(255, 215, 0, 0.8)';

        setTimeout(() => {
          termCard.style.boxShadow = '';
          descCard.style.boxShadow = '';
        }, 2000);

        hintsUsed++;
        const hintCountEl = document.getElementById('hint-count');
        if (hintCountEl) hintCountEl.textContent = hintsUsed;
      }
    }

    // CSS ã‚»ãƒ¬ã‚¯ã‚¿ç”¨ã«å¿…è¦ãªã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ï¼ˆç”¨èªã«ç‰¹æ®Šæ–‡å­—ãŒå…¥ã‚‹å¯èƒ½æ€§ã«å‚™ãˆã‚‹ï¼‰
    function escapeSelector(str) {
      return str.replace(/([ !"#$%&'()*+,.\/:;<=>?@[\\\]^`{|}~])/g, "\\$1");
    }

    function showCompletionModal() {
      const config = window.elementSdk?.config || defaultConfig;
      const customFont = config.font_family || defaultConfig.font_family;
      const baseSize = config.font_size || defaultConfig.font_size;
      const baseFontStack = 'sans-serif';

      const elapsedTime = Math.floor((Date.now() - gameStartTime) / 1000);
      const minutes = Math.floor(elapsedTime / 60);
      const seconds = elapsedTime % 60;

      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 flex items-center justify-center z-50';
      modal.style.background = 'rgba(0,0,0,0.8)';
      modal.innerHTML = `
        <div class="p-8 rounded-2xl shadow-2xl max-w-md w-full mx-4 text-center" style="background: ${config.card_background || defaultConfig.card_background};">
          <div class="text-6xl mb-4">ğŸ‰</div>
          <h2 class="text-4xl font-black mb-4" style="font-family: ${customFont}, ${baseFontStack}; font-size: ${baseSize * 2}px; color: ${config.text_color || defaultConfig.text_color};">
            ãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™ï¼
          </h2>
          <p class="text-xl mb-6" style="font-family: ${customFont}, ${baseFontStack}; font-size: ${baseSize}px; color: ${config.text_color || defaultConfig.text_color};">
            å…¨å•æ­£è§£ã—ã¾ã—ãŸï¼<br>
            æ™‚é–“: ${minutes}åˆ†${seconds}ç§’<br>
            ãƒ’ãƒ³ãƒˆä½¿ç”¨: ${hintsUsed}å›
          </p>

          <div class="mb-6">
            <label class="block text-left mb-2 font-bold" style="font-family: ${customFont}, ${baseFontStack}; font-size: ${baseSize * 0.9}px; color: ${config.text_color || defaultConfig.text_color};">
              ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼å
            </label>
            <input id="player-name-input" type="text" placeholder="åå‰ã‚’å…¥åŠ›" 
                   class="w-full p-3 rounded-lg border-2 focus:outline-none focus:border-blue-500"
                   style="font-family: ${customFont}, ${baseFontStack}; font-size: ${baseSize}px; background: ${config.background_color || defaultConfig.background_color}; color: ${config.text_color || defaultConfig.text_color}; border-color: ${config.term_color || defaultConfig.term_color};">
          </div>

          <div class="flex gap-4">
            <button id="save-score-btn" class="flex-1 px-6 py-3 rounded-lg text-white font-bold shadow-lg hover:shadow-xl transition-all" 
                    style="background: ${config.accent_color || defaultConfig.accent_color}; font-family: ${customFont}, ${baseFontStack}; font-size: ${baseSize * 0.9}px;">
              ã‚¹ã‚³ã‚¢ã‚’ä¿å­˜
            </button>
            <button id="play-again-btn" class="flex-1 px-6 py-3 rounded-lg text-white font-bold shadow-lg hover:shadow-xl transition-all" 
                    style="background: ${config.term_color || defaultConfig.term_color}; font-family: ${customFont}, ${baseFontStack}; font-size: ${baseSize * 0.9}px;">
              ã‚‚ã†ä¸€åº¦ãƒ—ãƒ¬ã‚¤
            </button>
          </div>
        </div>
      `;

      document.body.appendChild(modal);

      document.getElementById('save-score-btn').addEventListener('click', async () => {
        const playerName = document.getElementById('player-name-input').value.trim();
        if (!playerName) {
          const input = document.getElementById('player-name-input');
          input.style.borderColor = '#ef4444';
          return;
        }

        if (currentRecordCount >= 999) {
          const errorMsg = document.createElement('p');
          errorMsg.textContent = 'ã‚¹ã‚³ã‚¢ã®ä¿å­˜ä¸Šé™ï¼ˆ999ä»¶ï¼‰ã«é”ã—ã¾ã—ãŸ';
          errorMsg.style.color = '#ef4444';
          errorMsg.style.marginTop = '10px';
          errorMsg.style.fontFamily = `${customFont}, ${baseFontStack}`;
          document.getElementById('save-score-btn').parentElement.appendChild(errorMsg);
          return;
        }

        const saveBtn = document.getElementById('save-score-btn');
        saveBtn.disabled = true;
        saveBtn.textContent = 'ä¿å­˜ä¸­...';

        try {
          if (window.dataSdk && typeof window.dataSdk.create === 'function') {
            const result = await window.dataSdk.create({
              player_name: playerName,
              score: correctCount,
              total_questions: phpMethods.length,
              completed_at: new Date().toISOString()
            });

            if (result?.isOk) {
              modal.remove();
              resetGame();
            } else {
              throw new Error('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
          } else {
            // SDK ãŒãªã‘ã‚Œã°ãƒ­ãƒ¼ã‚«ãƒ«ã§ç°¡æ˜“ä¿å­˜ï¼ˆé–‹ç™ºæ™‚ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
            console.warn('dataSdk.create ãŒç„¡ã„ãŸã‚ãƒ­ãƒ¼ã‚«ãƒ«ã«ä¿å­˜ã—ã¾ã™ï¼ˆé–‹ç™ºç”¨ï¼‰');
            const records = JSON.parse(localStorage.getItem('local_scores_v1') || '[]');
            records.push({
              player_name: playerName,
              score: correctCount,
              total_questions: phpMethods.length,
              completed_at: new Date().toISOString()
            });
            localStorage.setItem('local_scores_v1', JSON.stringify(records));
            modal.remove();
            resetGame();
          }
        } catch (e) {
          saveBtn.disabled = false;
          saveBtn.textContent = 'ã‚¹ã‚³ã‚¢ã‚’ä¿å­˜';
          const errorMsg = document.createElement('p');
          errorMsg.textContent = 'ã‚¹ã‚³ã‚¢ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ';
          errorMsg.style.color = '#ef4444';
          errorMsg.style.marginTop = '10px';
          saveBtn.parentElement.appendChild(errorMsg);
        }
      });

      document.getElementById('play-again-btn').addEventListener('click', () => {
        modal.remove();
        resetGame();
      });
    }

    function resetGame() {
      selectedTerm = null;
      selectedDescription = null;
      matchedPairs.clear();
      correctCount = 0;
      hintsUsed = 0;
      gameStartTime = Date.now();
      renderGame();
    }

    function renderLeaderboard(data) {
      const config = window.elementSdk?.config || defaultConfig;
      const customFont = config.font_family || defaultConfig.font_family;
      const baseSize = config.font_size || defaultConfig.font_size;
      const baseFontStack = 'sans-serif';

      const container = document.getElementById('leaderboard-container');
      if (!container) return;

      // data ãŒæä¾›ã•ã‚Œãªã„å ´åˆã¯ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã®ç°¡æ˜“è¡¨ç¤ºã‚’è©¦ã¿ã‚‹
      let records = Array.isArray(data) ? data : null;
      if (!records) {
        const local = localStorage.getItem('local_scores_v1');
        if (local) {
          try {
            records = JSON.parse(local);
          } catch (e) {
            records = [];
          }
        } else {
          records = [];
        }
      }

      const sortedData = [...records].sort((a, b) => b.score - a.score).slice(0, 10);

      if (sortedData.length === 0) {
        container.innerHTML = `<p class="text-center" style="font-family: ${customFont}, ${baseFontStack}; font-size: ${baseSize}px; color: ${config.text_color || defaultConfig.text_color};">ã¾ã ã‚¹ã‚³ã‚¢ãŒã‚ã‚Šã¾ã›ã‚“</p>`;
        return;
      }

      container.innerHTML = sortedData.map((record, index) => {
        const date = new Date(record.completed_at);
        const medals = ['ğŸ¥‡', 'ğŸ¥ˆ', 'ğŸ¥‰'];
        const medal = index < 3 ? medals[index] : `${index + 1}.`;

        return `
          <div class="leaderboard-item p-4 rounded-lg flex justify-between items-center shadow-md" 
               style="background: ${config.card_background || defaultConfig.card_background}; font-family: ${customFont}, ${baseFontStack}; font-size: ${baseSize * 0.85}px; color: ${config.text_color || defaultConfig.text_color};">
            <div class="flex items-center gap-4">
              <span class="text-2xl font-bold">${medal}</span>
              <div>
                <div class="font-bold">${escapeHtml(record.player_name)}</div>
                <div class="text-sm opacity-75">${date.toLocaleDateString('ja-JP')}</div>
              </div>
            </div>
            <div class="text-right">
              <div class="text-2xl font-black">${record.score}/${record.total_questions}</div>
            </div>
          </div>
        `;
      }).join('');
    }

    function escapeHtml(str) {
      if (!str) return '';
      return String(str).replace(/[&<>"']/g, function (m) {
        return ({ '&':'&amp;', '<':'&lt;', '>':'&gt;', '"':'&quot;', "'":'&#39;' })[m];
      });
    }

    // åˆæœŸåŒ–å‘¼ã³å‡ºã—
    init();
  </script>
  <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9b420365e39ffcdb',t:'MTc2Njc2NzE1Ni4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script>
</body>
</html>
